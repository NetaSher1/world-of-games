pipeline {
    agent { label 'my-laptop' }

    stages {
        stage('Start App') {
            steps {
                echo 'Starting Flask app...'
                bat '''
                    cd C:\\Users\\P0031467\\PycharmProjects\\world-of-games
                    call .venv\\Scripts\\activate.bat
                    start python app.py
                '''
            }
        }

         stage('Test') {
            steps {
                echo 'Running Selenium tests...'
                script {
                    def exitCode = bat(script: '''
                        cd C:\\Users\\P0031467\\PycharmProjects\\world-of-games\\tests
                        start python e2e.py"
                    ''', returnStatus: true)

                    if (exitCode == 0) {
                        echo "Selenium tests passed"
                    } else {
                        error "Selenium tests failed with exit code ${exitCode}"
                    }
                }
            }
        }
    }

    post {
        failure {
            mail to: 'neta.sher@ness-tech.co.il',
                 subject: "Pipeline Failed: ${env.JOB_NAME} [${env.BUILD_NUMBER}]",
                 body: "Something went wrong in the pipeline. Check Jenkins for more details."
        }
        always {
            echo 'Cleaning up...'
            bat 'taskkill /IM python.exe /F' // Kill Flask app in Windows after completion
        }
    }
}